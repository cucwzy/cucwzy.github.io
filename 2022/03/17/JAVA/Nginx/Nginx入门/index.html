<!DOCTYPE html>

<html lang="en">

<head>
    
    <title>Nginx入门 - Shuyan</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <meta name="description" content="一、安装与配置1.1 windows1.1.1 下载下载官网：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;download.html 直接解压安装包 1.1.2 启动两种方法：  直接双击该目录下的”nginx.exe”，即可启动nginx服务器；  命令行进入该文件夹，执行start nginx命令，也会直接启动nginx服务器。   1.1.3 验证开浏览器，输入地址：http:&#x2F;&#x2F;localh">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx入门">
<meta property="og:url" content="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/index.html">
<meta property="og:site_name" content="Shuyan">
<meta property="og:description" content="一、安装与配置1.1 windows1.1.1 下载下载官网：https:&#x2F;&#x2F;nginx.org&#x2F;en&#x2F;download.html 直接解压安装包 1.1.2 启动两种方法：  直接双击该目录下的”nginx.exe”，即可启动nginx服务器；  命令行进入该文件夹，执行start nginx命令，也会直接启动nginx服务器。   1.1.3 验证开浏览器，输入地址：http:&#x2F;&#x2F;localh">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/8f900a89c6347c561fdf2122f13be562.png">
<meta property="og:image" content="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/Nginx%E5%85%A5%E9%97%A8.assets/image-20220409201312621.png">
<meta property="og:image" content="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/Nginx%E5%85%A5%E9%97%A8.assets/image-20220409211825533.png">
<meta property="og:image" content="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/Nginx%E5%85%A5%E9%97%A8.assets/image-20220409211918205.png">
<meta property="og:image" content="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/Nginx%E5%85%A5%E9%97%A8.assets/image-20220409212013259.png">
<meta property="article:published_time" content="2022-03-17T03:29:01.000Z">
<meta property="article:modified_time" content="2022-04-11T14:11:35.380Z">
<meta property="article:author" content="Shuyan">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/img_convert/8f900a89c6347c561fdf2122f13be562.png">
    <link rel="stylesheet" href="/lib/jquery.fancybox.min.css?v=1650551263748">
    
        <link rel="stylesheet" href="//at.alicdn.com/t/font_1038733_0xvrvpg9c0r.css">
    
    <link rel="stylesheet" href="/lib/mdui_043tiny/css/mdui.css?v=1650551263748">
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1650551263748">
    <link rel="stylesheet" href="/css/style.css?v=1650551263748">
     
    
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(http://mms0.baidu.com/it/u=2467909075,3604847220&amp;fm=253&amp;app=138&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=801&amp;h=500)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="Shuyan" class="mdui-btn mdui-btn-icon"><img src="http://mms2.baidu.com/it/u=1730774443,2723245118&amp;fm=253&amp;app=120&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" alt="Shuyan"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Shuyan">
            <img src="http://mms2.baidu.com/it/u=1730774443,2723245118&amp;fm=253&amp;app=120&amp;f=JPEG&amp;fmt=auto&amp;q=75?w=500&amp;h=500" alt="Shuyan" alt="Shuyan">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>Articles</span>63</div>
        <div><span>Tags</span>15</div>
        <div><span>Categories</span>25</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/categories" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about" title="梦华录">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                梦华录
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://cn.bing.com/search?q=site:nexmoe.com" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="Search"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://qm.qq.com/cgi-bin/qm/qr?k=rd1wdMWxpIZJe5AIruJkY7xD8d68h031&noverify=0" target="_blank" mdui-tooltip="{content: 'QQ'}" style="color: rgb(249, 174, 8);background-color: rgba(249, 174, 8, .1);">
            <i class="nexmoefont icon-QQ"></i>
        </a><a class="mdui-ripple" href="https://space.bilibili.com/400417888" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/nexmoe/" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Categories</h3>
    <div class="nexmoe-widget">

      <ul class="category-list">

        


        

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/C语言/">C语言</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/">JAVA</a>
          <span class="category-list-count">31</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/JavaWeb/">JavaWeb</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/LaTex/">LaTex</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/">Leetcode</a>
          <span class="category-list-count">16</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/Mybaits/">Mybaits</a>
          <span class="category-list-count">6</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/C语言/STL/">STL</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/Spring/">Spring</a>
          <span class="category-list-count">5</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/SpringBoot/">SpringBoot</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/SpringMVC/">SpringMVC</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/sort/">sort</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Docker”/">“Docker”</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“JVM”/">“JVM”</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Nginx”/">“Nginx”</a>
          <span class="category-list-count">8</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/JAVA/“Spring框架”/">“Spring框架”</a>
          <span class="category-list-count">18</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/二叉树/">二叉树</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/剑指offer/">剑指offer</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/动态规划/">动态规划</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/线性表/单链表/">单链表</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/字符串/">字符串</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/线性表/数组/">数组</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/算法/">算法</a>
          <span class="category-list-count">1</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/线性表/">线性表</a>
          <span class="category-list-count">3</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/联邦学习/">联邦学习</a>
          <span class="category-list-count">2</span>
        </li>

        

        <li class="category-list-item">
          <a class="category-list-link" href="/categories/Leetcode/贪心算法/">贪心算法</a>
          <span class="category-list-count">1</span>
        </li>

        
      </ul>

    </div>
  </div>


    
    
  <div class="nexmoe-widget-wrap">
    <h3 class="nexmoe-widget-title">Tag Cloud</h3>
    <div id="randomtagcloud" class="nexmoe-widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 11.67px;">Docker</a> <a href="/tags/JVM/" style="font-size: 13.33px;">JVM</a> <a href="/tags/JavaWeb/" style="font-size: 13.33px;">JavaWeb</a> <a href="/tags/LaTex/" style="font-size: 10px;">LaTex</a> <a href="/tags/Leetcode/" style="font-size: 20px;">Leetcode</a> <a href="/tags/Mybaits/" style="font-size: 16.67px;">Mybaits</a> <a href="/tags/Nginx/" style="font-size: 18.33px;">Nginx</a> <a href="/tags/STL/" style="font-size: 13.33px;">STL</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/SpringBoot/" style="font-size: 13.33px;">SpringBoot</a> <a href="/tags/SpringMVC/" style="font-size: 10px;">SpringMVC</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 10px;">二叉树</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size: 10px;">动态规划</a> <a href="/tags/%E6%90%9C%E7%B4%A2/" style="font-size: 11.67px;">搜索</a> <a href="/tags/%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0/" style="font-size: 11.67px;">联邦学习</a>
    </div>
    
  </div>
  <style>
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+1) {
    background-color: rgba(255,78,106,0.15);
    color: rgba(255,78,106,0.8);
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+2) {
    background-color: rgba(255,170,115,0.15);
    color: #ffaa73;
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+3) {
    background-color: rgba(254,212,102,0.15);
    color: #fed466;
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+4) {
    background-color: rgba(60,220,130,0.15);
    color: #3cdc82;
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+5) {
    background-color: rgba(100,220,240,0.15);
    color: #64dcf0;
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+6) {
    background-color: rgba(100,185,255,0.15);
    color: #64b9ff;
    }
    #nexmoe-header .nexmoe-widget-wrap .tagcloud a:nth-child(7n+7) {
    background-color: rgba(180,180,255,0.15);
    color: #b4b4ff;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta {
    margin: 25px 0px;
    font-size: 0;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a {
    border-radius: 20px;
    padding: 10px 18px;
    color: #fff;
    font-size: 14px;
    display: inline-block;
    margin-bottom: 5px;
    margin-right: 10px;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a .nexmoefont {
    font-size: 14px;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:before,
    #nexmoe-content .nexmoe-post .nexmoe-post-meta i:before {
    margin-right: 5px;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+1) {
    background-color: rgba(255,78,106,0.15);
    color: #ff4e6a;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+2) {
    background-color: rgba(255,170,115,0.15);
    color: #ffaa73;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+3) {
    background-color: rgba(254,212,102,0.15);
    color: #fed466;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+4) {
    background-color: rgba(60,220,130,0.15);
    color: #3cdc82;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+5) {
    background-color: rgba(100,220,240,0.15);
    color: #64dcf0;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+6) {
    background-color: rgba(100,185,255,0.15);
    color: #64b9ff;
    }
    #nexmoe-content .nexmoe-post .nexmoe-post-meta a:nth-child(7n+7) {
    background-color: rgba(180,180,255,0.15);
    color: #b4b4ff;
    }
  </style>


    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2022 Shuyan
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br><a target="_blank" href=" "><img src="http://mms0.baidu.com/it/u=991445098,3809803602&fm=253&app=138&f=JPEG&fmt=auto&q=75?w=500&h=500" width="100px" ></a><script data-ad-client="ca-pub-2058306854838448" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <div class="nexmoe-post">

  <article>
      
          <div class="nexmoe-post-cover" style="padding-bottom: 62.5%;"> 
              <img data-src="/img/Nginx入门.jpg" data-sizes="auto" alt="Nginx入门" class="lazyload">
              <h1>Nginx入门</h1>
          </div>
      
      
      <div class="nexmoe-post-meta nexmoe-rainbow" style="margin:10px 0!important;">
    <a><i class="nexmoefont icon-calendar-fill"></i>2022年03月17日</a>
</div>

      

      <h1 id="一、安装与配置"><a href="#一、安装与配置" class="headerlink" title="一、安装与配置"></a>一、安装与配置</h1><h2 id="1-1-windows"><a href="#1-1-windows" class="headerlink" title="1.1 windows"></a>1.1 windows</h2><h3 id="1-1-1-下载"><a href="#1-1-1-下载" class="headerlink" title="1.1.1 下载"></a>1.1.1 下载</h3><p>下载官网：<a target="_blank" rel="noopener" href="https://nginx.org/en/download.html">https://nginx.org/en/download.html</a></p>
<p>直接解压安装包</p>
<h3 id="1-1-2-启动"><a href="#1-1-2-启动" class="headerlink" title="1.1.2 启动"></a>1.1.2 启动</h3><p>两种方法：</p>
<ul>
<li><p>直接双击该目录下的”<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=nginx&spm=1001.2101.3001.7020">nginx</a>.exe”，即可启动nginx服务器；</p>
</li>
<li><p>命令行进入该文件夹，执行start nginx命令，也会直接启动nginx服务器。</p>
</li>
</ul>
<h3 id="1-1-3-验证"><a href="#1-1-3-验证" class="headerlink" title="1.1.3 验证"></a>1.1.3 验证</h3><p>开浏览器，输入地址：<a target="_blank" rel="noopener" href="http://localhost,访问页面,出现如下页面表示访问成功./">http://localhost，访问页面，出现如下页面表示访问成功。</a></p>
<h3 id="1-1-4-基本操作"><a href="#1-1-4-基本操作" class="headerlink" title="1.1.4 基本操作"></a>1.1.4 基本操作</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx">启动服务：	<span class="hljs-attribute">start</span> nginx<br>退出服务：	nginx -s quit<br>强制关闭服务：nginx -s stop<br>重载服务：	nginx -s reload　　（重载服务配置文件，类似于重启，服务不会中止）<br>验证配置文件：nginx -t<br>使用配置文件：nginx -c <span class="hljs-string">&quot;配置文件路径&quot;</span><br>使用帮助：	nginx -h<br></code></pre></td></tr></table></figure>



<h2 id="1-2-Linux"><a href="#1-2-Linux" class="headerlink" title="1.2 Linux"></a>1.2 Linux</h2><h3 id="1-2-1-Nginx依赖包"><a href="#1-2-1-Nginx依赖包" class="headerlink" title="1.2.1 Nginx依赖包"></a>1.2.1 Nginx依赖包</h3><p>模块依赖性Nginx需要依赖下面3个包</p>
<ol>
<li>ssl功能需要 openssl 库 ( <a target="_blank" rel="noopener" href="http://www.openssl.org/">点击下载</a> )</li>
<li>gzip模块需要 zlib 库 ( <a target="_blank" rel="noopener" href="http://www.zlib.net/">点击下载</a> )</li>
<li>rewrite模块需要 pcre 库 ( <a target="_blank" rel="noopener" href="http://www.pcre.org/">点击下载</a> )</li>
</ol>
<p>依赖包安装顺序依次为：openssl、zlib、pcre, 最后安装Nginx包。</p>
<h3 id="1-2-2-安装"><a href="#1-2-2-安装" class="headerlink" title="1.2.2 安装"></a>1.2.2 安装</h3><h4 id="step-1：下载所需包"><a href="#step-1：下载所需包" class="headerlink" title="step 1：下载所需包"></a>step 1：下载所需包</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">openssl-fips-2.0.2.tar.gz<br>zlib-1.2.7.tar.gz<br>pcre-8.21.tar.gz<br>nginx-1.12.2.tar.gz<br></code></pre></td></tr></table></figure>

<h4 id="step-2：安装OpenSSL"><a href="#step-2：安装OpenSSL" class="headerlink" title="step 2：安装OpenSSL"></a>step 2：安装OpenSSL</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost wcw]<span class="hljs-comment"># tar -zxvf openssl-fips-2.0.2.tar.gz </span><br>[root@localhost wcw]<span class="hljs-comment"># cd openssl-fips-2.0.2</span><br>[root@localhost openssl-fips-2.0.2]<span class="hljs-comment"># ./config </span><br>[root@localhost openssl-fips-2.0.2]<span class="hljs-comment"># make</span><br>[root@localhost openssl-fips-2.0.2]<span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>

<h4 id="step-3：安装zlib"><a href="#step-3：安装zlib" class="headerlink" title="step 3：安装zlib"></a>step 3：安装zlib</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost wcw]<span class="hljs-comment"># tar -zxvf zlib-1.2.7.tar.gz</span><br>[root@localhost wcw]<span class="hljs-comment"># cd zlib-1.2.7</span><br>[root@localhost zlib-1.2.7]<span class="hljs-comment"># ./configure </span><br>[root@localhost zlib-1.2.7]<span class="hljs-comment"># make</span><br>[root@localhost zlib-1.2.7]<span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>

<h4 id="step-4：安装pcre"><a href="#step-4：安装pcre" class="headerlink" title="step 4：安装pcre"></a>step 4：安装pcre</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost wcw]<span class="hljs-comment"># tar -zxvf pcre-8.21.tar.gz</span><br>[root@localhost wcw]<span class="hljs-comment"># cd pcre-8.21</span><br>[root@localhost pcre-8.21]<span class="hljs-comment"># ./configure </span><br>[root@localhost pcre-8.21]<span class="hljs-comment"># make</span><br>[root@localhost pcre-8.21]<span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>

<h4 id="step-5：安装Nginx"><a href="#step-5：安装Nginx" class="headerlink" title="step 5：安装Nginx"></a>step 5：安装Nginx</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost wcw]<span class="hljs-comment"># tar -zxvf nginx-1.12.2.tar.gz </span><br>[root@localhost wcw]<span class="hljs-comment"># cd nginx-1.12.2</span><br>[root@localhost nginx-1.12.2]<span class="hljs-comment"># ./configure --prefix=/usr/install/nginx --with-pcre=../pcre-8.21 --with-zlib=../zlib-1.2.7 --with-openssl=../openssl-fips-2.0.2</span><br>[root@localhost nginx-1.12.2]<span class="hljs-comment"># make</span><br>[root@localhost nginx-1.12.2]<span class="hljs-comment"># make install</span><br></code></pre></td></tr></table></figure>

<p>请注意：”<strong>–with-xxx=</strong>“的值是解压目录，而不是安装目录</p>
<h3 id="1-2-3-基本操作指令"><a href="#1-2-3-基本操作指令" class="headerlink" title="1.2.3 基本操作指令"></a>1.2.3 基本操作指令</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx">启动服务：<span class="hljs-attribute">nginx</span><br>退出服务：nginx -s quit<br>强制关闭服务：nginx -s stop<br>重载服务：nginx -s reload　　（重载服务配置文件，类似于重启，但服务不会中止）<br>验证配置文件：nginx -t<br>使用配置文件：nginx -c <span class="hljs-string">&quot;配置文件路径&quot;</span><br>使用帮助：nginx -h<br></code></pre></td></tr></table></figure>

<p>此时可以为Nginx添加环境变量，以便操作服务。（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wcwnina/p/9351108.html">&gt;&gt;如何添加Linux环境变量？</a>）</p>
<p>检测是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost wcw]<span class="hljs-comment"># nginx -t</span><br></code></pre></td></tr></table></figure>

<p>出现如下提示，表示安装成功。</p>
<p>或者，在浏览器地址输入”127.0.0.1”回车出现如下页面，则表示安装成功。</p>
<h2 id="1-3-Nginx配置文件说明"><a href="#1-3-Nginx配置文件说明" class="headerlink" title="1.3 Nginx配置文件说明"></a>1.3 Nginx配置文件说明</h2><p>在项目使用中，使用最多的三个核心功能是静态服务器、反向代理和负载均衡。</p>
<p>这三个不同的功能的使用，都跟Nginx的配置密切相关，Nginx服务器的配置信息主要集中在”nginx.conf”这个配置文件中，并且所有的可配置选项大致分为以下几个部分。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">main</span>                                <span class="hljs-comment"># 全局配置</span><br> <br>events &#123;                            <span class="hljs-comment"># 工作模式配置</span><br> <br>&#125;<br> <br><span class="hljs-section">http</span> &#123;                              <span class="hljs-comment"># http设置</span><br>    ....<br> <br>    <span class="hljs-section">server</span> &#123;                        <span class="hljs-comment"># 服务器主机配置（虚拟主机、反向代理等）</span><br>        ....<br>        <span class="hljs-section">location</span> &#123;                  <span class="hljs-comment"># 路由配置（虚拟目录等）</span><br>            ....<br>        &#125;<br> <br>        <span class="hljs-attribute">location</span> path &#123;<br>            ....<br>        &#125;<br> <br>        <span class="hljs-attribute">location</span> otherpath &#123;<br>            ....<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-section">server</span> &#123;<br>        ....<br>        <span class="hljs-section">location</span> &#123;<br>            ....<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-attribute">upstream</span> name &#123;                  <span class="hljs-comment"># 负载均衡配置</span><br>        ....<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="1-3-1-main模块"><a href="#1-3-1-main模块" class="headerlink" title="1.3.1 main模块"></a>1.3.1 main模块</h3><ul>
<li>user  用来指定nginx worker进程运行用户以及用户组，默认nobody账号运行</li>
<li>worker_processes  指定nginx要开启的子进程数量，运行过程中监控每个进程消耗内存(一般几M~几十M不等)根据实际情况进行调整，通常数量是CPU内核数量的整数倍</li>
<li>error_log  定义错误日志文件的位置及输出级别【debug / info / notice / warn / error / crit】</li>
<li>pid  用来指定进程id的存储文件的位置</li>
<li>worker_rlimit_nofile  用于指定一个进程可以打开最多文件数量的描述</li>
<li>…</li>
</ul>
<h3 id="1-3-2-event模块"><a href="#1-3-2-event模块" class="headerlink" title="1.3.2 event模块"></a>1.3.2 event模块</h3><ul>
<li>worker_connections  指定最大可以同时接收的连接数量，这里一定要注意，最大连接数量是和worker processes共同决定的。</li>
<li>multi_accept  配置指定nginx在收到一个新连接通知后尽可能多的接受更多的连接</li>
<li>use epoll  配置指定了线程轮询的方法，如果是linux2.6+，使用epoll，如果是BSD如Mac请使用Kqueue</li>
<li>…</li>
</ul>
<h3 id="1-3-3-http模块"><a href="#1-3-3-http模块" class="headerlink" title="1.3.3 http模块"></a>1.3.3 http模块</h3><p>作为web服务器，http模块是nginx最核心的一个模块，配置项也是比较多的，项目中会设置到很多的实际业务场景，需要根据硬件信息进行适当的配置。</p>
<h4 id="1）基础配置"><a href="#1）基础配置" class="headerlink" title="1）基础配置"></a>1）基础配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>：配置<span class="hljs-literal">on</span>让sendfile发挥作用，将文件的回写过程交给数据缓冲去去完成，而不是放在应用中完成，这样的话在性能提升有有好处<br>tcp_nopush <span class="hljs-literal">on</span>：让nginx在一个数据包中发送所有的头文件，而不是一个一个单独发<br>tcp_nodelay <span class="hljs-literal">on</span>：让nginx不要缓存数据，而是一段一段发送，如果数据的传输有实时性的要求的话可以配置它，发送完一小段数据就立刻能得到返回值，但是不要滥用哦<br> <br>keepalive_timeout <span class="hljs-number">10</span>：给客户端分配连接超时时间，服务器会在这个时间过后关闭连接。一般设置时间较短，可以让nginx工作持续性更好<br>client_header_timeout <span class="hljs-number">10</span>：设置请求头的超时时间<br>client_body_timeout <span class="hljs-number">10</span>:设置请求体的超时时间<br>send_timeout <span class="hljs-number">10</span>：指定客户端响应超时时间，如果客户端两次操作间隔超过这个时间，服务器就会关闭这个链接<br> <br>limit_conn_zone $binary_remote_addr zone=addr:<span class="hljs-number">5m</span> ：设置用于保存各种key的共享内存的参数，<br>limit_conn addr <span class="hljs-number">100</span>: 给定的key设置最大连接数<br> <br>server_tokens：虽然不会让nginx执行速度更快，但是可以在错误页面关闭nginx版本提示，对于网站安全性的提升有好处哦<br>include /etc/nginx/mime.types：指定在当前文件中包含另一个文件的指令<br>default_type application/octet-stream：指定默认处理的文件类型可以是二进制<br>type_hash_max_size <span class="hljs-number">2048</span>：混淆数据，影响三列冲突率，值越大消耗内存越多，散列key冲突率会降低，检索速度更快；值越小key，占用内存较少，冲突率越高，检索速度变慢<br></code></pre></td></tr></table></figure>

<h4 id="2）日志配置"><a href="#2）日志配置" class="headerlink" title="2）日志配置"></a>2）日志配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">access_log</span> logs/access.log：设置存储访问记录的日志<br><br>error_log logs/error.log：设置存储记录错误发生的日志<br></code></pre></td></tr></table></figure>

<h4 id="3）SSL证书配置"><a href="#3）SSL证书配置" class="headerlink" title="3）SSL证书配置"></a>3）SSL证书配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx">ssl_protocols：指令用于启动特定的加密协议，nginx在1.1.13和1.0.12版本后默认是<span class="hljs-attribute">ssl_protocols</span> SSLv3 TLSv1 TLSv1.<span class="hljs-number">1</span> TLSv1.<span class="hljs-number">2</span>，TLSv1.<span class="hljs-number">1</span>与TLSv1.<span class="hljs-number">2</span>要确保OpenSSL &gt;= <span class="hljs-number">1</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span> ，SSLv3 现在还有很多地方在用但有不少被攻击的漏洞。<br><br>ssl prefer server ciphers：设置协商加密算法时，优先使用我们服务端的加密套件，而不是客户端浏览器的加密套件<br></code></pre></td></tr></table></figure>

<h4 id="4）压缩配置"><a href="#4）压缩配置" class="headerlink" title="4）压缩配置"></a>4）压缩配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">gzip</span> 是告诉nginx采用gzip压缩的形式发送数据。这将会减少我们发送的数据量。<br><br>gzip_disable 为指定的客户端禁用gzip功能。我们设置成IE6或者更低版本以使我们的方案能够广泛兼容。<br><br>gzip_static 告诉nginx在压缩资源之前，先查找是否有预先gzip处理过的资源。这要求你预先压缩你的文件（在这个例子中被注释掉了），从而允许你使用最高压缩比，这样nginx就不用再压缩这些文件了（想要更详尽的gzip_static的信息，请点击这里）。<br><br>gzip_proxied 允许或者禁止压缩基于请求和响应的响应流。我们设置为any，意味着将会压缩所有的请求。<br><br>gzip_min_length 设置对数据启用压缩的最少字节数。如果一个请求小于<span class="hljs-number">1000</span>字节，我们最好不要压缩它，因为压缩这些小的数据会降低处理此请求的所有进程的速度。<br><br>gzip_comp_level 设置数据的压缩等级。这个等级可以是<span class="hljs-number">1</span>-<span class="hljs-number">9</span>之间的任意数值，<span class="hljs-number">9</span>是最慢但是压缩比最大的。我们设置为<span class="hljs-number">4</span>，这是一个比较折中的设置。<br><br>gzip_type 设置需要压缩的数据格式。上面例子中已经有一些了，你也可以再添加更多的格式。<br></code></pre></td></tr></table></figure>

<h4 id="5）文件缓存配置"><a href="#5）文件缓存配置" class="headerlink" title="5）文件缓存配置"></a>5）文件缓存配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">open_file_cache</span> 打开缓存的同时也指定了缓存最大数目，以及缓存的时间。我们可以设置一个相对高的最大时间，这样我们可以在它们不活动超过<span class="hljs-number">20</span>秒后清除掉。<br><br>open_file_cache_valid 在open_file_cache中指定检测正确信息的间隔时间。<br><br>open_file_cache_min_uses 定义了open_file_cache中指令参数不活动时间期间里最小的文件数。<br><br>open_file_cache_errors 指定了当搜索一个文件时是否缓存错误信息，也包括再次给配置中添加文件。我们也包括了服务器模块，这些是在不同文件中定义的。如果你的服务器模块不在这些位置，你就得修改这一行来指定正确的位置。<br></code></pre></td></tr></table></figure>

<h3 id="1-3-4-sever模块"><a href="#1-3-4-sever模块" class="headerlink" title="1.3.4 sever模块"></a>1.3.4 sever模块</h3><p>srever模块配置是http模块中的一个子模块，用来定义一个虚拟访问主机，也就是一个虚拟服务器的配置信息。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>         <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span>    localhost  <span class="hljs-number">192.168.1.100</span>;<br>    <span class="hljs-attribute">charset</span>        utf-<span class="hljs-number">8</span>;<br>    <span class="hljs-attribute">access_log</span>     logs/access.log;<br>    <span class="hljs-attribute">error_log</span>      logs/error.log;<br>    ......<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>server：一个虚拟主机的配置，一个http中可以配置多个server</li>
<li>server_name：用来指定ip地址或者域名，多个配置之间用空格分隔</li>
<li>charset：用于设置www/路径中配置的网页的默认编码格式</li>
<li>access_log：用于指定该虚拟主机服务器中的访问记录日志存放路径</li>
<li>error_log：用于指定该虚拟主机服务器中访问错误日志的存放路径</li>
</ul>
<h3 id="1-3-5-location模块"><a href="#1-3-5-location模块" class="headerlink" title="1.3.5 location模块"></a>1.3.5 location模块</h3><p>location模块是Nginx配置中出现最多的一个配置，主要用于配置路由访问信息。</p>
<p>在路由访问信息配置中关联到反向代理、负载均衡等等各项功能，所以location模块也是一个非常重要的配置模块。</p>
<h4 id="1）基本配置"><a href="#1）基本配置" class="headerlink" title="1）基本配置"></a>1）基本配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">root</span>    /nginx/www;<br>    <span class="hljs-attribute">index</span>    index.php index.html index.htm;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>location /：表示匹配访问根目录</li>
<li>root：用于指定访问根目录时，访问虚拟主机的web目录</li>
<li>index：在不指定访问具体资源时，默认展示的资源文件列表</li>
</ul>
<h4 id="2）反向代理配置"><a href="#2）反向代理配置" class="headerlink" title="2）反向代理配置"></a>2）反向代理配置</h4><p>通过反向代理代理服务器访问模式，通过proxy_set配置让客户端访问透明化。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://localhost:8888;<br>    <span class="hljs-attribute">proxy_set_header</span> X-real-ip $remote_addr;<br>    <span class="hljs-attribute">proxy_set_header</span> Host $http_host;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3）uwsgi配置"><a href="#3）uwsgi配置" class="headerlink" title="3）uwsgi配置"></a>3）uwsgi配置</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;<br>    <span class="hljs-attribute">include</span> uwsgi_params;<br>    <span class="hljs-attribute">uwsgi_pass</span> localhost:<span class="hljs-number">8888</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-6-负载均衡模块（upstream）"><a href="#1-3-6-负载均衡模块（upstream）" class="headerlink" title="1.3.6 负载均衡模块（upstream）"></a>1.3.6 负载均衡模块（upstream）</h3><p>upstream模块主要负责负载均衡的配置，通过默认的轮询调度方式来分发请求到后端服务器。简单的配置方式如下。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> name &#123;<br>    ip_hash;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.1.100:8000</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.1.100:8001</span> down;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.1.100:8002</span> max_fails=<span class="hljs-number">3</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.1.100:8003</span> fail_timeout=<span class="hljs-number">20s</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.1.100:8004</span> max_fails=<span class="hljs-number">3</span> fail_timeout=<span class="hljs-number">20s</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ip_hash：指定请求调度算法，默认是weight权重轮询调度，可以指定</li>
<li>server host:port：分发服务器的列表配置</li>
<li>– down：表示该主机暂停服务</li>
<li>– max_fails：表示失败最大次数，超过失败最大次数暂停服务</li>
<li>– fail_timeout：表示如果请求受理失败，暂停指定的时间之后重新发起请求</li>
</ul>
<h2 id="1-4-Nginx主要配置"><a href="#1-4-Nginx主要配置" class="headerlink" title="1.4 Nginx主要配置"></a>1.4 Nginx主要配置</h2><h3 id="1-4-1-静态Http服务器配置"><a href="#1-4-1-静态Http服务器配置" class="headerlink" title="1.4.1 静态Http服务器配置"></a>1.4.1 静态Http服务器配置</h3><p>首先，Nginx是一个HTTP服务器，可以将服务器上的静态文件（如HTML、图片）通过HTTP协议展现给客户端。<br>配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>; 　　<span class="hljs-comment"># 端口</span><br>    <span class="hljs-attribute">server_name</span> localhost  <span class="hljs-number">192.168.1.100</span>; 　　<span class="hljs-comment"># 域名   </span><br>    <span class="hljs-attribute">location</span> / &#123;　　　　　　　　　　　　　<span class="hljs-comment"># 代表这是项目根目录</span><br>        <span class="hljs-attribute">root</span> /usr/share/nginx/www; 　 <span class="hljs-comment"># 虚拟目录</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-2-反向代理服务器配置"><a href="#1-4-2-反向代理服务器配置" class="headerlink" title="1.4.2 反向代理服务器配置"></a>1.4.2 反向代理服务器配置</h3><p>什么是反向代理？<br>客户端本来可以直接通过HTTP协议访问某网站应用服务器，如果网站管理员在中间加上一个Nginx，客户端请求Nginx，Nginx请求应用服务器，然后将结果返回给客户端，此时Nginx就是反向代理服务器。</p>
<p>负载均衡配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> myapp &#123;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.0.111:8080</span>; 　　<span class="hljs-comment"># 应用服务器1</span><br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.0.112:8080</span>; 　　<span class="hljs-comment"># 应用服务器2</span><br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://myweb;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-3-虚拟主机配置"><a href="#1-4-3-虚拟主机配置" class="headerlink" title="1.4.3 虚拟主机配置"></a>1.4.3 虚拟主机配置</h3><p>有的网站访问量大，需要负载均衡。然而并不是所有网站都如此出色，有的网站，由于访问量太小，需要节省成本，将多个网站部署在同一台服务器上。<br>例如将<a target="_blank" rel="noopener" href="http://www.aaa.com和www.bbb.com两个网站部署在同一台服务器上,两个域名解析到同一个ip地址,但是用户通过两个域名却可以打开两个完全不同的网站,互相不影响,就像访问两个服务器一样,所以叫两个虚拟主机./">www.aaa.com和www.bbb.com两个网站部署在同一台服务器上，两个域名解析到同一个IP地址，但是用户通过两个域名却可以打开两个完全不同的网站，互相不影响，就像访问两个服务器一样，所以叫两个虚拟主机。</a></p>
<p>虚拟主机配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;<br>    <span class="hljs-attribute">server_name</span> _;<br>    <span class="hljs-attribute">return</span> <span class="hljs-number">444</span>; 　　<span class="hljs-comment"># 过滤其他域名的请求，返回444状态码</span><br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.aaa.com; 　　<span class="hljs-comment"># www.aaa.com域名</span><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://localhost:8080; 　　<span class="hljs-comment"># 对应端口号8080</span><br>    &#125;<br>&#125;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;<br>    <span class="hljs-attribute">server_name</span> www.bbb.com; 　　<span class="hljs-comment"># www.bbb.com域名</span><br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">proxy_pass</span> http://localhost:8081; 　　<span class="hljs-comment"># 对应端口号8081</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在服务器8080和8081分别开了一个应用，客户端通过不同的域名访问，根据server_name可以反向代理到对应的应用服务器。</p>
<p>虚拟主机的原理是通过HTTP请求头中的Host是否匹配server_name来实现的，有兴趣的同学可以研究一下HTTP协议。</p>
<p>另外，server_name配置还可以过滤有人恶意将某些域名指向你的主机服务器。</p>
<h3 id="1-4-4-Nginx开机启动-方法1，适用CentOS7，systemctl管理服务"><a href="#1-4-4-Nginx开机启动-方法1，适用CentOS7，systemctl管理服务" class="headerlink" title="1.4.4 Nginx开机启动(方法1，适用CentOS7，systemctl管理服务)"></a>1.4.4 Nginx开机启动(方法1，适用CentOS7，systemctl管理服务)</h3><h5 id="CentOS7系统服务脚本目录"><a href="#CentOS7系统服务脚本目录" class="headerlink" title="CentOS7系统服务脚本目录"></a>CentOS7系统服务脚本目录</h5><p>用户（user）：用户登录后才能运行的程序，存在用户（user）。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx">/usr/lib/systemd/user<br></code></pre></td></tr></table></figure>

<p>系统（system）：如需要开机没有登陆情况下就能运行的程序，存在系统服务（system）里。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx">/usr/lib/systemd/system<br></code></pre></td></tr></table></figure>

<h5 id="编写service脚本"><a href="#编写service脚本" class="headerlink" title="编写service脚本"></a>编写service脚本</h5><p>服务文件名以**.**service结尾：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> /usr/lib/systemd/system/nginx.service<br></code></pre></td></tr></table></figure>

<p>编写脚本内容（固定格式）：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx">[Unit]<br>Description=<span class="hljs-attribute">nginx</span><br>After=network.target<br><br>[Service]<br>Type=forking<br>PIDFile=/usr/install/nginx/logs/nginx.pid<br>ExecStart=/usr/install/nginx/sbin/nginx<br>ExecReload=/usr/install/nginx/sbin/nginx -s reload<br>ExecStop=/usr/install/nginx/sbin/nginx -s stop<br>PrivateTmp=<span class="hljs-literal">true</span><br><br>[Install]<br>WantedBy=multi-user.target<br></code></pre></td></tr></table></figure>

<p>以上路径必须均为绝对路径！！而ExecStart、ExecReload、ExecStop的值也可以是”/etc/init.d”下的自定义的<strong>sh</strong>脚本文件的绝对路径，我就是采用这种方式来实现 <strong>uWSGI</strong> 开机启动的：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs nginx">/etc/init.d目录下的uWSGI服务启动脚本文件&quot;uwsgi-start.sh&quot;：<br><span class="hljs-comment">#!/bin/sh</span><br>/pyvenv/bin/<span class="hljs-attribute">uwsgi</span> --ini /pyvenv/src/eduonline/uwsgi.ini;<br>/etc/init.d目录下的uWSGI服务重启脚本文件&quot;uwsgi-restart.sh&quot;：<br><br><span class="hljs-comment">#!/bin/sh</span><br>/pyvenv/bin/<span class="hljs-attribute">uwsgi</span> --restart /pyvenv/src/eduonline/uwsgi.pid;<br>/etc/init.d目录下的uWSGI服务停止脚本文件&quot;uwsgi-stop.sh&quot;：<br><br><span class="hljs-comment">#!/bin/sh</span><br>/pyvenv/bin/<span class="hljs-attribute">uwsgi</span> --stop /pyvenv/src/eduonline/uwsgi.pid;<br></code></pre></td></tr></table></figure>

<p>注意：sh脚本中同样采用绝对路径！！保存后，赋予可读可执行权限。然后编写service脚本文件。</p>
<h3 id="设置开机启动（强大的CentOS服务管理工具systemctl）"><a href="#设置开机启动（强大的CentOS服务管理工具systemctl）" class="headerlink" title="设置开机启动（强大的CentOS服务管理工具systemctl）"></a>设置开机启动（强大的CentOS服务管理工具systemctl）</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">systemctl</span> enable nginx.service      <span class="hljs-comment">#&quot;.service&quot;可省略</span><br><span class="hljs-comment"># 附其他命令：</span><br>systemctl start nginx.service       <span class="hljs-comment"># 启动</span><br>systemctl restart nginx.service     <span class="hljs-comment"># 重启，服务会中止一会儿</span><br>systemctl reload nginx.service　　　 <span class="hljs-comment"># 重载服务配置文件，类似于重启，但服务不会中止</span><br>systemctl stop nginx.service        <span class="hljs-comment"># 停止</span><br>systemctl disable nginx.service     <span class="hljs-comment"># 关闭开机启动</span><br></code></pre></td></tr></table></figure>

<p>如果提示”Failed to execute operation: Access denied”，输入”systemctl daemon-reexec”可解决。</p>
<h3 id="1-4-5-Nginx开机启动-方法2，适用CentOS7以下"><a href="#1-4-5-Nginx开机启动-方法2，适用CentOS7以下" class="headerlink" title="1.4.5 Nginx开机启动(方法2，适用CentOS7以下)"></a>1.4.5 Nginx开机启动(方法2，适用CentOS7以下)</h3><p>首先，在Linux系统的”/etc/init.d/“目录下创建nginx脚本文件，使用如下命令：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">touch</span> nginx       <span class="hljs-comment"># 创建</span><br>vim nginx         <span class="hljs-comment"># 编辑</span><br></code></pre></td></tr></table></figure>

<p>在脚本中添加如下命令：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="https://img-blog.csdnimg.cn/img_convert/8f900a89c6347c561fdf2122f13be562.png" alt="img" class="lazyload"> View Code</p>
<p>保存脚本文件后对所有用户追加可执行权限：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chmod</span> a+x /etc/init.d/nginx<br></code></pre></td></tr></table></figure>

<p> 先将nginx服务加入chkconfig管理列表：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chkconfig</span> --add /etc/init.d/nginx<br></code></pre></td></tr></table></figure>

<p>设置终端模式开机启动：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">chkconfig</span> nginx <span class="hljs-literal">on</span><br></code></pre></td></tr></table></figure>



<h1 id="二、Nginx入门"><a href="#二、Nginx入门" class="headerlink" title="二、Nginx入门"></a>二、Nginx入门</h1><h2 id="2-1-Nginx功能介绍"><a href="#2-1-Nginx功能介绍" class="headerlink" title="2.1 Nginx功能介绍"></a>2.1 Nginx功能介绍</h2><p>​        Nginx因为它的稳定性、丰富的模块库、灵活的配置和低系统资源的消耗而闻名．业界一致认为它是Apache2.2＋mod_proxy_balancer的轻量级代替者，不仅因为响应静态页面的速度非常快，而且它的模块数量是<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=Apache&spm=1001.2101.3001.7020">Apache</a>的2/3。对proxy和rewrite模块的支持很彻底，还支持mod_fcgi、ssl、vhosts ，适合用做mongrel clusters前端HTTP响应。<br>nginx和Apache一样用模块化设计，nginx模块包括内置模块和第三方模块，其中内置模块中包含主模块和事件模块。</p>
<p>nginx处理请求逻辑图</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="Nginx%E5%85%A5%E9%97%A8.assets/image-20220409201312621.png" alt="image-20220409201312621" class="lazyload"></p>
<h2 id="2-2-Nginx可以提供的服务"><a href="#2-2-Nginx可以提供的服务" class="headerlink" title="2.2 Nginx可以提供的服务"></a>2.2 Nginx可以提供的服务</h2><ul>
<li><p>web 服务.</p>
</li>
<li><p>负载均衡 （反向代理）</p>
</li>
<li><p>web cache（web 缓存）</p>
</li>
</ul>
<h2 id="2-3-Nginx优势"><a href="#2-3-Nginx优势" class="headerlink" title="2.3 Nginx优势"></a>2.3 Nginx优势</h2><ul>
<li><p>高并发。静态小文件</p>
</li>
<li><p>占用资源少。2万并发、10个线程，内存消耗几百M。</p>
</li>
<li><p>功能种类比较多。web,cache,proxy。每一个功能都不是特别强。</p>
</li>
<li><p>支持epoll模型，使得nginx可以支持高并发。</p>
</li>
<li><p>nginx 配合动态服务和Apache有区别。（FASTCGI 接口）</p>
</li>
<li><p>利用nginx可以对IP限速，可以限制连接数。</p>
</li>
<li><p>配置简单，更灵活。</p>
</li>
</ul>
<h2 id="2-4-Nginx应用场合"><a href="#2-4-Nginx应用场合" class="headerlink" title="2.4 Nginx应用场合"></a>2.4 Nginx应用场合</h2><ul>
<li><p>静态服务器(图片，视频服务)，另个lighttpd。并发几万，html，js，css，flv，jpg，gif等。</p>
</li>
<li><p>动态服务，nginx—fastcgi 方式运行PHP，jsp。(PHP并发约500-1500，MySQL 并发约300-1500）。</p>
</li>
<li><p>反向代理，负载均衡。日pv2000W以下，都可直接用nginx做代理。</p>
</li>
<li><p>缓存服务。类似 SQUID,VARNISH。</p>
</li>
</ul>
<h2 id="2-5-Nginx监控"><a href="#2-5-Nginx监控" class="headerlink" title="2.5 Nginx监控"></a>2.5 Nginx监控</h2><p>开启 nginx 监控服务</p>
<h3 id="2-5-1-开启状态页"><a href="#2-5-1-开启状态页" class="headerlink" title="2.5.1 开启状态页"></a>2.5.1 开启状态页</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># 设定查看 Nginx 状态地址   </span><br><span class="hljs-attribute">location</span> /status &#123;  <br>  <span class="hljs-attribute">stub_status</span> <span class="hljs-literal">on</span>;   				<span class="hljs-comment"># 表示开启stubStatus的工作状态统计功能。</span><br>  <span class="hljs-attribute">access_log</span> <span class="hljs-literal">off</span>;   				<span class="hljs-comment"># access_log off; 关闭access_log 日志记录功能。</span><br>  <span class="hljs-comment">#auth_basic &quot;status&quot;;   		# auth_basic 是nginx的一种认证机制。</span><br>  <span class="hljs-comment">#auth_basic_user_file conf/htpasswd;	# 用来指定密码文件的位置。</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-5-2-配置登录密码"><a href="#2-5-2-配置登录密码" class="headerlink" title="2.5.2 配置登录密码"></a>2.5.2 配置登录密码</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">yum</span> install -y httpd-tools<br>/usr/local/apache/bin/htpasswd -c /data/nginx/conf/htpasswd biglittleant <br>New password:<br></code></pre></td></tr></table></figure>

<p>完成后会在 <code>/data/nginx/conf/</code> 目录下生成 <code>htpasswd</code> 文件。</p>
<h3 id="2-5-3-访问URL"><a href="#2-5-3-访问URL" class="headerlink" title="2.5.3 访问URL"></a>2.5.3 访问URL</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">curl</span> http://127.0.0.1/status<br><br>Active connections:  <span class="hljs-number">1</span><br>server accepts handled requests<br> <span class="hljs-number">16</span> <span class="hljs-number">16</span> <span class="hljs-number">18</span><br>Reading: <span class="hljs-number">0</span> Writing: <span class="hljs-number">1</span> Waiting: <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<blockquote>
<p>active connections – 活跃的连接数量<br>server accepts handled requests — 总共处理了16个连接 , 成功创建16次握手, 总共处理了18个请求<br>Reading — 读取客户端的连接数:<br>Writing 响应数据到客户端的数量;<br>Waiting 开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 即 Nginx 已处理完正在等候下一次请求指令的驻留连接.</p>
</blockquote>
<h3 id="2-5-4-编写zabbix监控脚本"><a href="#2-5-4-编写zabbix监控脚本" class="headerlink" title="2.5.4 编写zabbix监控脚本"></a>2.5.4 编写zabbix监控脚本</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs nginx">nginx_status_fun()&#123;<br>    NGINX_PORT=$1<br>    NGINX_COMMAND=$2<br>    nginx_active()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| grep <span class="hljs-string">&#x27;Active&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print $NF&#125;&#x27;</span><br>        &#125;<br>    nginx_reading()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| grep <span class="hljs-string">&#x27;Reading&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$2</span>&#125;&#x27;</span><br>       &#125;<br>    nginx_writing()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| grep <span class="hljs-string">&#x27;Writing&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$4</span>&#125;&#x27;</span><br>       &#125;<br>    nginx_waiting()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| grep <span class="hljs-string">&#x27;Waiting&#x27;</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$6</span>&#125;&#x27;</span><br>       &#125;<br>    nginx_accepts()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| awk NR==<span class="hljs-number">3</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$1</span>&#125;&#x27;</span><br>       &#125;<br>    nginx_handled()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| awk NR==<span class="hljs-number">3</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$2</span>&#125;&#x27;</span><br>       &#125;<br>    nginx_requests()&#123;<br>        /usr/bin/<span class="hljs-attribute">curl</span> <span class="hljs-string">&quot;http://127.0.0.1:&quot;</span>$NGINX_PORT<span class="hljs-string">&quot;/status/&quot;</span> <span class="hljs-number">2</span>&gt;/dev/null| awk NR==<span class="hljs-number">3</span> | awk <span class="hljs-string">&#x27;&#123;print <span class="hljs-variable">$3</span>&#125;&#x27;</span><br>       &#125;<br>    case $NGINX_COMMAND in<br>        active)<br>            nginx_active;<br>            ;;<br>        reading)<br>            nginx_reading;<br>            ;;<br>        writing)<br>            nginx_writing;<br>            ;;<br>        waiting)<br>            nginx_waiting;<br>            ;;<br>        accepts)<br>            nginx_accepts;<br>            ;;<br>        handled)<br>            nginx_handled;<br>            ;;<br>        requests)<br>            nginx_requests;<br>        <span class="hljs-attribute">esac</span> <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-6-Nginx优化"><a href="#2-6-Nginx优化" class="headerlink" title="2.6 Nginx优化"></a>2.6 Nginx优化</h2><h3 id="2-6-1-nginx内核优化"><a href="#2-6-1-nginx内核优化" class="headerlink" title="2.6.1 nginx内核优化"></a>2.6.1 nginx内核优化</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Nginx">net.ipv4.<span class="hljs-attribute">tcp_fin_timeout</span> = <span class="hljs-number">2</span><br>net.ipv4.tcp_tw_reuse = <span class="hljs-number">1</span><br>net.ipv4.tcp_tw_recycle = <span class="hljs-number">1</span><br>net.ipv4.tcp_syncookies = <span class="hljs-number">1</span><br>net.ipv4.tcp_keepalive_time = <span class="hljs-number">600</span><br>net.ipv4.ip_local_port_range = <span class="hljs-number">4000</span>    <span class="hljs-number">65000</span><br>net.ipv4.tcp_max_syn_backlog = <span class="hljs-number">16384</span><br>net.ipv4.tcp_max_tw_buckets = <span class="hljs-number">36000</span><br>net.ipv4.route.gc_timeout = <span class="hljs-number">100</span><br>net.ipv4.tcp_syn_retries = <span class="hljs-number">1</span><br>net.ipv4.tcp_synack_retries = <span class="hljs-number">1</span><br>net.core.somaxconn = <span class="hljs-number">16384</span><br>net.core.netdev_max_backlog = <span class="hljs-number">16384</span><br>net.ipv4.tcp_max_orphans = <span class="hljs-number">16384</span><br><span class="hljs-comment">#以下参数是对iptables防火墙的优化，防火墙不开会提示，可以忽略不理。</span><br>net.ipv4.ip_conntrack_max = <span class="hljs-number">25000000</span><br>net.ipv4.netfilter.ip_conntrack_max=<span class="hljs-number">25000000</span><br>net.ipv4.netfilter.ip_conntrack_tcp_timeout_established=<span class="hljs-number">180</span><br>net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait=<span class="hljs-number">120</span><br>net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait=<span class="hljs-number">60</span><br>net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait=<span class="hljs-number">120</span><br></code></pre></td></tr></table></figure>

<h3 id="2-6-2-TCP-优化"><a href="#2-6-2-TCP-优化" class="headerlink" title="2.6.2 TCP 优化"></a>2.6.2 TCP 优化</h3><p>Nginx 关于 TCP 的优化基本都是修改系统内核提供的配置项，所以跟具体的 Linux 版本和系统配置有关，我对这一块还不是非常熟悉，这里只能简单介绍下：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">sendfile</span>           <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">tcp_nopush</span>         <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">tcp_nodelay</span>        <span class="hljs-literal">on</span>;<br><br>    <span class="hljs-attribute">keepalive_timeout</span>  <span class="hljs-number">60</span>;<br>    ... ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        第一行的 <code>sendfile</code> 配置可以提高 Nginx 静态资源托管效率。sendfile 是一个系统调用，直接在内核空间完成文件发送，不需要先 read 再 write，没有上下文切换开销。</p>
<p>​        TCP_NOPUSH 是 FreeBSD 的一个 socket 选项，对应 Linux 的 TCP_CORK，Nginx 里统一用 <code>tcp_nopush</code> 来控制它，并且只有在启用了 sendfile 之后才生效。启用它之后，数据包会累计到一定大小之后才会发送，减小了额外开销，提高网络效率。</p>
<p>​        TCP_NODELAY 也是一个 socket 选项，启用后会禁用 Nagle 算法，尽快发送数据，某些情况下可以节约 200ms（Nagle 算法原理是：在发出去的数据还未被确认之前，新生成的小数据先存起来，凑满一个 MSS 或者等到收到确认后再发送）。Nginx 只会针对处于 keep-alive 状态的 TCP 连接才会启用 <code>tcp_nodelay</code>。</p>
<p>​        可以看到 TCP_NOPUSH 是要等数据包累积到一定大小才发送，TCP_NODELAY 是要尽快发送，二者相互矛盾。实际上，它们确实可以一起用，最终的效果是先填满包，再尽快发送。</p>
<p>​        关于这部分内容的更多介绍可以看这篇文章：<a target="_blank" rel="noopener" href="https://t37.net/nginx-optimization-understanding-sendfile-tcp_nodelay-and-tcp_nopush.html">NGINX OPTIMIZATION: UNDERSTANDING SENDFILE, TCP_NODELAY AND TCP_NOPUSH</a>。</p>
<p>​        配置最后一行用来指定服务端为每个 TCP 连接最多可以保持多长时间。Nginx 的默认值是 75 秒，有些浏览器最多只保持 60 秒，所以我统一设置为 60。</p>
<p>​        另外，还有一个 TCP 优化策略叫 TCP Fast Open（TFO），这里先介绍下，配置在后面贴出。TFO 的作用是用来优化 TCP 握手过程。客户端第一次建立连接还是要走三次握手，所不同的是客户端在第一个 SYN 会设置一个 Fast Open 标识，服务端会生成 Fast Open Cookie 并放在 SYN-ACK 里，然后客户端就可以把这个 Cookie 存起来供之后的 SYN 用。下面这个图形象地描述了这个过程：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="Nginx%E5%85%A5%E9%97%A8.assets/image-20220409211825533.png" alt="image-20220409211825533" class="lazyload"></p>
<p>​        关于 TCP Fast Open 的更多信息，可以查看 <a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc7413.txt">RFC7413</a>，或者这篇文章：<a target="_blank" rel="noopener" href="https://bradleyf.id.au/nix/shaving-your-rtt-wth-tfo/">Shaving your RTT with TCP Fast Open</a>。需要注意的是，现阶段只有 Linux、ChromeOS 和 Android 5.0 的 Chrome / Chromium 才支持 TFO，所以实际用途并不大。</p>
<p>​        5 月 26 日发布的 Nginx 1.9.1，增加了 <code>reuseport</code> 功能，意味着 Nginx 也开始支持 TCP 的 SO_REUSEPORT 选项了。这里也先简单介绍下，具体配置方法后面统一介绍。启用这个功能后，Nginx 会在指定的端口上监听多个 socket，每个 Worker 都能分到一个。请求过来时，系统内核会自动通过不同的 socket 分配给对应的 Worker，相比之前的单 socket 多 Worker 的模式，提高了分发效率。下面这个图形象地描述了这个过程</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="Nginx%E5%85%A5%E9%97%A8.assets/image-20220409211918205.png" alt="image-20220409211918205" class="lazyload"></p>
<p>有关这部分内容的更多信息，可以查看 Nginx 的官方博客：<a target="_blank" rel="noopener" href="http://nginx.com/blog/socket-sharding-nginx-release-1-9-1/">Socket Sharding in NGINX Release 1.9.1</a>。</p>
<h3 id="2-6-3-开启-Gzip"><a href="#2-6-3-开启-Gzip" class="headerlink" title="2.6.3 开启 Gzip"></a>2.6.3 开启 Gzip</h3><p>​        我们在上线前，代码（JS、CSS 和 HTML）会做压缩，图片也会做压缩（PNGOUT、Pngcrush、JpegOptim、Gifsicle 等）。对于文本文件，在服务端发送响应之前进行 GZip 压缩也很重要，通常压缩后的文本大小会减小到原来的 1/4 - 1/3。下面是我的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;<br>    <span class="hljs-attribute">gzip</span>               <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">gzip_vary</span>          <span class="hljs-literal">on</span>;<br><br>    <span class="hljs-attribute">gzip_comp_level</span>    <span class="hljs-number">6</span>;<br>    <span class="hljs-attribute">gzip_buffers</span>       <span class="hljs-number">16</span> <span class="hljs-number">8k</span>;<br><br>    <span class="hljs-attribute">gzip_min_length</span>    <span class="hljs-number">1000</span>;<br>    <span class="hljs-attribute">gzip_proxied</span>       any;<br>    <span class="hljs-attribute">gzip_disable</span>       <span class="hljs-string">&quot;msie6&quot;</span>;<br><br>    <span class="hljs-attribute">gzip_http_version</span>  <span class="hljs-number">1</span>.<span class="hljs-number">0</span>;<br><br>    <span class="hljs-attribute">gzip_types</span>         text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;<br>    ... ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        这部分内容比较简单，只有两个地方需要解释下：</p>
<p>​        <code>gzip_vary</code> 用来输出 Vary 响应头，用来解决某些缓存服务的一个问题，详情请看我之前的博客：<a target="_blank" rel="noopener" href="https://imququ.com/post/vary-header-in-http.html">HTTP 协议中 Vary 的一些研究</a>。</p>
<p>​        <code>gzip_disable</code> 指令接受一个正则表达式，当请求头中的 UserAgent 字段满足这个正则时，响应不会启用 GZip，这是为了解决在某些浏览器启用 GZip 带来的问题。特别地，指令值 <code>msie6</code> 等价于 <code>MSIE [4-6]\.</code>，但性能更好一些。另外，Nginx 0.8.11 后，<code>msie6</code> 并不会匹配 UA 包含 <code>SV1</code> 的 IE6（例如 Windows XP SP2 上的 IE6），因为这个版本的 IE6 已经修复了关于 GZip 的若干 Bug。</p>
<p>​        默认 Nginx 只会针对 HTTP/1.1 及以上的请求才会启用 GZip，因为部分早期的 HTTP/1.0 客户端在处理 GZip 时有 Bug。现在基本上可以忽略这种情况，于是可以指定 <code>gzip_http_version 1.0</code> 来针对 HTTP/1.0 及以上的请求开启 GZip。</p>
<h3 id="2-6-4-开启缓存"><a href="#2-6-4-开启缓存" class="headerlink" title="2.6.4 开启缓存"></a>2.6.4 开启缓存</h3><p>​        优化代码逻辑的极限是移除所有逻辑；优化请求的极限是不发送任何请求。这两点通过缓存都可以实现。</p>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p>​        实现静态化有很多种方案， 例如：Nginx 的 proxy_cache</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_cache_path</span>  /home/jerry/cache/nginx/proxy_cache_path levels=<span class="hljs-number">1</span>:<span class="hljs-number">2</span> keys_zone=pnc:<span class="hljs-number">300m</span> inactive=<span class="hljs-number">7d</span> max_size=<span class="hljs-number">10g</span>;<br><span class="hljs-attribute">proxy_temp_path</span>   /home/jerry/cache/nginx/proxy_temp_path;<br><span class="hljs-attribute">proxy_cache_key</span>   $host$uri$is_args$args;<br><br><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">location</span> / &#123;<br>        <span class="hljs-attribute">resolver</span>                  <span class="hljs-number">127.0.0.1</span>;  <br>        <span class="hljs-attribute">proxy_cache</span>               pnc;<br>        <span class="hljs-attribute">proxy_cache_valid</span>         <span class="hljs-number">200</span> <span class="hljs-number">304</span> <span class="hljs-number">2h</span>;<br>        <span class="hljs-attribute">proxy_cache_lock</span>          <span class="hljs-literal">on</span>;<br>        <span class="hljs-attribute">proxy_cache_lock_timeout</span>  <span class="hljs-number">5s</span>;<br>        <span class="hljs-attribute">proxy_cache_use_stale</span>     updating <span class="hljs-literal">error</span> timeout invalid_header http_500 http_502;<br><br>        <span class="hljs-attribute">proxy_http_version</span>        <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;<br><br>        <span class="hljs-attribute">proxy_ignore_headers</span>      Set-Cookie;<br>        ... ...<br>    &#125;<br>    ... ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        首先，在配置最外层定义一个缓存目录，并指定名称（keys_zone）和其他属性，这样在配置 proxy_pass 时，就可以使用这个缓存了。这里我对状态值等于 200 和 304 的响应缓存了 2 小时。</p>
<p>​        默认情况下，如果响应头里有 Set-Cookie 字段，Nginx 并不会缓存这次响应，因为它认为这次响应的内容是因人而异的。我的博客中，这个 Set-Cookie 对于用户来说没有用，也不会影响输出内容，所以我通过配置 <code>proxy_ignore_header</code> 移除了它。</p>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>​        服务端在输出响应时，可以通过响应头输出一些与缓存有关的信息，从而达到少发或不发请求的目的。HTTP/1.1 的缓存机制稍微有点复杂，这里简单介绍下：</p>
<p>​        首先，服务端可以通过响应头里的 <code>Last-Modified</code>（最后修改时间） 或者 <code>ETag</code>（内容特征） 标记实体。浏览器会存下这些标记，并在下次请求时带上 <code>If-Modified-Since: 上次 Last-Modified 的内容</code> 或 <code>If-None-Match: 上次 ETag 的内容</code>，询问服务端资源是否过期。如果服务端发现并没有过期，直接返回一个状态码为 304、正文为空的响应，告知浏览器使用本地缓存；如果资源有更新，服务端返回状态码 200、新的 Last-Modified、Etag 和正文。这个过程被称之为 HTTP 的协商缓存，通常也叫做弱缓存。</p>
<p>​        可以看到协商缓存并不会节省连接数，但是在缓存生效时，会大幅减小传输内容（304 响应没有正文，一般只有几百字节）。另外为什么有两个响应头都可以用来实现协商缓存呢？这是因为一开始用的 <code>Last-Modified</code> 有两个问题：1）只能精确到秒，1 秒内的多次变化反映不出来；2）<del>时间采用绝对值，如果服务端 / 客户端时间不对都可能导致缓存失效</del>在轮询的负载均衡算法中，如果各机器读到的文件修改时间不一致，有缓存无故失效和缓存不更新的风险。HTTP/1.1 并没有规定 <code>ETag</code> 的生成规则，而一般实现者都是对资源内容做摘要，能解决前面两个问题。</p>
<p>​        另外一种缓存机制是服务端通过响应头告诉浏览器，在什么时间之前（Expires）或在多长时间之内（Cache-Control: Max-age=xxx），不要再请求服务器了。这个机制我们通常称之为 HTTP 的强缓存。</p>
<p>​        一旦资源命中强缓存规则后，再次访问完全没有 HTTP 请求（Chrome 开发者工具的 Network 面板依然会显示请求，但是会注明 from cache；Firefox 的 firebug 也类似，会注明 BFCache），这会大幅提升性能。所以我们一般会对 CSS、JS、图片等资源使用强缓存，而入口文件（HTML）一般使用协商缓存或不缓存，这样可以通过修改入口文件中对强缓存资源的引入 URL 来达到即时更新的目的。</p>
<p>​        这里也解释下为什么有了 <code>Expires</code>，还要有 <code>Cache-Control</code>。也有两个原因：1）Cache-Control 功能更强大，对缓存的控制能力更强；2）Cache-Control 采用的 max-age 是相对时间，不受服务端 / 客户端时间不对的影响。</p>
<p>​        另外关于浏览器的刷新（F5 / cmd + r）和强刷（Ctrl + F5 / shift + cmd +r）：普通刷新会使用协商缓存，忽略强缓存；强刷会忽略浏览器所有缓存（并且请求头会携带 Cache-Control:no-cache 和 Pragma:no-cache，用来通知所有中间节点忽略缓存）。只有从地址栏或收藏夹输入网址、点击链接等情况下，浏览器才会使用强缓存。</p>
<p>​        默认情况下，Nginx 对于静态资源都会输出 <code>Last-Modified</code>，而 <code>ETag</code>、<code>Expires</code> 和 <code>Cache-Control</code> 则需要自己配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/static/</span> &#123;<br>    <span class="hljs-attribute">root</span>      /home/jerry/www/blog/www;<br>    <span class="hljs-attribute">etag</span>      <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">expires</span>   max;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        <code>expires</code> 指令可以指定具体的 max-age，例如 <code>10y</code> 代表 10 年，如果指定为 <code>max</code>，最终输出的 <code>Expires</code> 会是 2037 年最后一天，<code>Cache-Control</code> 的 <code>max-age</code> 会是 10 年（准确说是 3650 天，315360000 秒）。</p>
<h3 id="2-6-5-使用-SPDY（HTTP-2）"><a href="#2-6-5-使用-SPDY（HTTP-2）" class="headerlink" title="2.6.5 使用 SPDY（HTTP/2）"></a>2.6.5 使用 SPDY（HTTP/2）</h3><p>​        之前多次讲到过 HTTP/2（SPDY），现阶段 Nginx 只支持 SPDY/3.1，这样配置就可以启用了（编译 Nginx 时需要加上 –with-http_spdy_module 和 –with-http_ssl_module）：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">listen</span>             <span class="hljs-number">443</span> ssl spdy fastopen=<span class="hljs-number">3</span> reuseport;<br>    <span class="hljs-attribute">spdy_headers_comp</span>  <span class="hljs-number">6</span>;<br>    ... ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        那个 <code>fastopen=3</code> 用来开启前面介绍过的 TCP Fast Open 功能。3 代表最多只能有 3 个未经三次握手的 TCP 链接在排队。超过这个限制，服务端会退化到采用普通的 TCP 握手流程。这是为了减少资源耗尽攻击：TFO 可以在第一次 SYN 的时候发送 HTTP 请求，而服务端会校验 Fast Open Cookie（FOC），如果通过就开始处理请求。如果不加限制，恶意客户端可以利用合法的 FOC 发送大量请求耗光服务端资源。</p>
<p>​        <code>reuseport</code> 就是用来启用前面介绍过的 TCP SO_REUSEPORT 选项的配置。</p>
<h3 id="2-6-6-HTTPS-优化"><a href="#2-6-6-HTTPS-优化" class="headerlink" title="2.6.6 HTTPS 优化"></a>2.6.6 HTTPS 优化</h3><p>​        建立 HTTPS 连接本身就慢（多了获取证书、校验证书、TLS 握手等等步骤），如果没有优化好只能是慢上加慢。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;<br>    <span class="hljs-attribute">ssl_session_cache</span>        shared:SSL:<span class="hljs-number">10m</span>;<br>    <span class="hljs-attribute">ssl_session_timeout</span>      <span class="hljs-number">60m</span>;<br><br>    <span class="hljs-attribute">ssl_session_tickets</span>      <span class="hljs-literal">on</span>;<br><br>    <span class="hljs-attribute">ssl_stapling</span>             <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">ssl_stapling_verify</span>      <span class="hljs-literal">on</span>;<br>    <span class="hljs-attribute">ssl_trusted_certificate</span>  /xxx/full_chain.crt;<br><br>    <span class="hljs-attribute">resolver</span>                 <span class="hljs-number">8.8.4.4</span> <span class="hljs-number">8.8.8.8</span>  valid=<span class="hljs-number">300s</span>;<br>    <span class="hljs-attribute">resolver_timeout</span>         <span class="hljs-number">10s</span>;<br>    ... ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>​        这部分配置：TLS 会话恢复和 OCSP stapling。</p>
<p>​        TLS 会话恢复的目的是为了简化 TLS 握手，有两种方案：Session Cache 和 Session Ticket。他们都是将之前握手的 Session 存起来供后续连接使用，所不同是 Cache 存在服务端，占用服务端资源；Ticket 存在客户端，不占用服务端资源。另外目前主流浏览器都支持 Session Cache，而 Session Ticket 的支持度一般。</p>
<p>​        <code>ssl_stapling</code> 开始的几行用来配置 OCSP stapling 策略。浏览器可能会在建立 TLS 连接时在线验证证书有效性，从而阻塞 TLS 握手，拖慢整体速度。OCSP stapling 是一种优化措施，服务端通过它可以在证书链中封装证书颁发机构的 OCSP（Online Certificate Status Protocol）响应，从而让浏览器跳过在线查询。服务端获取 OCSP 一方面更快（因为服务端一般有更好的网络环境），另一方面可以更好地缓存。有关 OCSP stapling 的详细介绍，可以<a target="_blank" rel="noopener" href="https://raymii.org/s/tutorials/OCSP_Stapling_on_nginx.html">看这里</a>。</p>
<p>这些策略设置好之后，可以通过 <a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/index.html">Qualys SSL Server Test</a> 这个工具来验证是否生效，例如下图就是本博客的测试结果（<a target="_blank" rel="noopener" href="https://www.ssllabs.com/ssltest/analyze.html?d=imququ.com">via</a>）：</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="Nginx%E5%85%A5%E9%97%A8.assets/image-20220409212013259.png" alt="image-20220409212013259" class="lazyload"></p>
<p>​        在给 Nginx 指定证书时，需要选择合适的证书链。因为浏览器在验证证书信任链时，会从站点证书开始，递归验证父证书，直至信任的根证书。这里涉及到两个问题：1）服务器证书是在握手期间发送的，由于 TCP 初始拥塞窗口的存在，如果证书太长很可能会产生额外的往返开销；2）如果服务端证书没包含中间证书，大部分浏览器可以正常工作，但会暂停验证并根据子证书指定的父证书 URL 自己获取中间证书。这个过程会产生额外的 DNS 解析、建立 TCP 连接等开销。配置服务端证书链的最佳实践是包含<strong>站点证书</strong>和<strong>中间证书</strong>两部分。有的证书提供商签出来的证书级别比较多，这会导致证书链变长，选择的时候需要特别注意。</p>
<h2 id="2-7-扩展一：nginx全局变量"><a href="#2-7-扩展一：nginx全局变量" class="headerlink" title="2.7 扩展一：nginx全局变量"></a>2.7 扩展一：nginx全局变量</h2><ul>
<li><code>$args</code>：这个变量等于请求行中的参数，同$query_string。</li>
<li><code>$is_args</code>: 如果已经设置<code>$args</code>，则该变量的值为”?”，否则为””。</li>
<li><code>$content_length</code>： 请求头中的Content-length字段。</li>
<li><code>$content_type</code>： 请求头中的Content-Type字段。</li>
<li><code>$document_uri</code>： 与$uri相同。</li>
<li><code>$document_root</code>： 当前请求在root指令中指定的值。</li>
<li><code>$host</code>： 请求主机头字段，否则为服务器名称。</li>
<li><code>$http_user_agent</code>： 客户端agent信息。</li>
<li><code>$http_cookie</code>： 客户端cookie信息。</li>
<li><code>$limit_rate</code>： 这个变量可以限制连接速率。</li>
<li><code>$request_method</code>： 客户端请求的动作，通常为GET或POST。</li>
<li><code>$remote_addr</code>： 客户端的IP地址。</li>
<li><code>$remote_port</code>： 客户端的端口。</li>
<li><code>$remote_user</code>： 已经经过Auth Basic Module验证的用户名。</li>
<li>$request_body_file`: 客户端请求主体的临时文件名。</li>
<li><code>$request_uri</code>: 请求的URI，带参数</li>
<li><code>$request_filename</code>： 当前请求的文件路径，由root或alias指令与URI请求生成。</li>
<li><code>$scheme</code>： 所用的协议，比如http或者是https，比如<code>rewrite ^(.+)$ $scheme://example.com$1 redirect;</code>。</li>
<li><code>$server_protocol</code>： 请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</li>
<li><code>$server_addr</code>： 服务器地址，在完成一次系统调用后可以确定这个值。</li>
<li><code>$server_name</code>： 服务器名称。</li>
<li><code>$server_port</code>： 请求到达服务器的端口号。</li>
<li><code>$request_uri</code>： 包含请求参数的原始URI，不包含主机名，如：<code>/foo/bar.php?arg=baz</code>，它无法修改。</li>
<li><code>$uri</code>： 不带请求参数的当前URI，$uri不包含主机名，如<code>/foo/bar.html</code>可能和最初的值有不同，比如经过重定向之类的。它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如/foo/bar.html。</li>
</ul>
<p>例子：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx">访问链接是：http://localhost:88/test1/test.<span class="hljs-attribute">php</span> <br>网站路径是：/var/www/html<br><br>$host：localhost<br>$server_port：<span class="hljs-number">88</span><br>$request_uri：http://localhost:88/test1/test.php<br>$document_uri：/test1/test.php<br>$document_root：/var/www/html<br>$request_filename：/var/www/html/test1/test.php<br></code></pre></td></tr></table></figure>

<h3 id="nginx-plus-–-ngx-http-status-module"><a href="#nginx-plus-–-ngx-http-status-module" class="headerlink" title="nginx plus – ngx_http_status_module"></a>nginx plus – ngx_http_status_module</h3><p>​        商业版的 nginx plus 通过他的 ngx_http_status_module 提供了比 nginx 更多的监控指标，可以参看 <a target="_blank" rel="noopener" href="http://demo.nginx.com/status.html">http://demo.nginx.com/status.html</a></p>
<h3 id="nginx-access-log-分析"><a href="#nginx-access-log-分析" class="headerlink" title="nginx access log 分析"></a>nginx access log 分析</h3><p>​        nginx 的 access log 中可以记录很多有价值的信息，通过分析 access log，可以收集到很多指标。<br>​        python 编写的 linux 工具 ngxtop 就实现了对 access log 的分析功能。</p>
<h3 id="NDK-–-ngx-devel-kit"><a href="#NDK-–-ngx-devel-kit" class="headerlink" title="NDK – ngx_devel_kit"></a>NDK – ngx_devel_kit</h3><p>​        NDK 是一个拓展nginx服务器核心功能的模块，第三方模块开发可以基于它来快速实现。NDK提供函数和宏处理一些基本任务，减轻第三方模块开发的代码量。</p>
<h3 id="nginx-lua-–-lua-nginx-module"><a href="#nginx-lua-–-lua-nginx-module" class="headerlink" title="nginx lua – lua-nginx-module"></a>nginx lua – lua-nginx-module</h3><p>​        nginx的lua模块，通过这个模块，可以对nginx做定制开发</p>
<h2 id="2-8-扩展二：web服务器事件处理模型"><a href="#2-8-扩展二：web服务器事件处理模型" class="headerlink" title="2.8 扩展二：web服务器事件处理模型"></a>2.8 扩展二：web服务器事件处理模型</h2><h3 id="2-8-1-select"><a href="#2-8-1-select" class="headerlink" title="2.8.1 select"></a>2.8.1 select</h3><p>​        select 最早于1983年出现在4.2BSD中，通过一个select()系统调用来监视多个文件描述符的数组，当select()返回后，该数组中就绪的文件描述符便会被内核修改标志位，使进程可获得这些文件描述符从而进行后续的读写操作。<br>​        select 目前几乎在所有的平台上支持，其良好跨平台支持也是它的一个优点，事实上从现在看来，这也是它所剩不多的优点之一。<br>select 的一个缺点在于单个进程能够监视的文件描述符的数量存在最大限制，Linux上一般为1024，不过可通过修改宏定义甚至重新编译内核的方式提升这一限制。<br>​        另外，select()所维护的存储大量文件描述符的数据结构，随着文件描述符数量的增大，其复制的开销也线性增长。同时，由于网络响应时间的延迟使得大量TCP连接处于非活跃状态，但调用 select() 会对所有socket进行一次线性扫描，所以这也浪费了一定开销。</p>
<h3 id="2-8-2-poll"><a href="#2-8-2-poll" class="headerlink" title="2.8.2 poll"></a>2.8.2 poll</h3><p>​        poll 在1986年诞生于System V Release 3，它和 select 在本质上没多大差别，但是 poll 没有最大文件描述符数量的限制。<br>​        poll 和select 同样存在的缺点是，包含大量文件描述符的数组被整体复制于用户态和内核的地址空间间，而不论文件描述符是否就绪，它的开销随着文件描述符数量的增加而线性增大。<br>​        另外，select() 和 poll() 将就绪的文件描述符告诉进程后，如果进程没对其进行IO操作，那下次调用 select() 和 poll() 时将再次报告这些文件描述符，所以它们一般不会丢失就绪的消息，这种方式称为水平触发（Level Triggered）。</p>
<h3 id="2-8-3-epoll"><a href="#2-8-3-epoll" class="headerlink" title="2.8.3 epoll"></a>2.8.3 epoll</h3><p>​        直到Linux2.6才出现了由内核直接支持的实现方法，就是epoll，它几乎具备之前说的一切优点，被公认为Linux2.6下性能最好的多路I/O就绪通知方法。<br>epoll 可同时支持水平触发和边缘触发（Edge Triggered，只告诉进程哪些文件描述符刚刚变为就绪状态，它只说一遍，如果没有采取行动，那它将不会再次告知，这种方式称为边缘触发），理论上边缘触发的性能要更高些，但代码实现相当复杂。<br>epoll同样只告知那些就绪的文件描述符，而且当调用epoll_wait()获得就绪文件描述符时，返回的不是实际的描述符，而是个代表就绪描述符数量的值，只需要去epoll指定的一个数组中依次取得相应数量的文件描述符即可，这里也用了内存映射（mmap）技术，这样便彻底省掉了这些文件描述符在系统调用时复制的开销。<br>​        另个本质的改进在于 epoll 采用基于事件的就绪通知方式。在 select/poll 中，进程只有在调用一定的方法后，内核才对所有监视的文件描述符进行扫描，而epoll事先通过 epoll_ctl() 来注册一个文件描述符，一旦基于某个文件描述符就绪时，内核会采用类似 callback 的回调机制，迅速激活这个文件描述符，当进程调用 epoll_wait() 时便得到通知。</p>
<h3 id="2-8-4-nginx-s-reload-过程"><a href="#2-8-4-nginx-s-reload-过程" class="headerlink" title="2.8.4 nginx -s reload 过程"></a>2.8.4 nginx -s reload 过程</h3><p>​        nginx主进程读取配置文件，如果发现配置文件变更，会创建一个新的主进程，然后同时旧的进程，及旧的子进程关闭，旧进程会拒绝新的连接，服务到自己的连接结束，然后关闭。</p>
<h3 id="2-8-5-Apache-select模型和-nginx-epoll-模型对比讲解"><a href="#2-8-5-Apache-select模型和-nginx-epoll-模型对比讲解" class="headerlink" title="2.8.5 Apache select模型和 nginx epoll 模型对比讲解"></a>2.8.5 Apache select模型和 nginx epoll 模型对比讲解</h3><p>​        Nginx高并发得益于其采用了 epoll 模型，与传统的服务器架构不同，epoll 是linux内核2.6后才出现的。下面通过比较Apache和Nginx工作原理来比较。</p>
<p>​        传统Apache都是多进程或者多线程来工作，假设是多进程工作（prefork），apache会先生成几个进程，类似进程池的工作原理，只不过这里的进程池会随着请求数目的增加而增加。对于每一个连接，apache都是在一个进程内处理完毕。具体是 recv（），及根据 URI 去进行磁盘I/O来寻找文件，还有 send（）都是阻塞的。其实说白了都是 apche 对套接字的I/O，读或写，但读或写都是阻塞的，阻塞意味着进程得挂起进入sleep状态，那一旦连接数很多，Apache必然要生成更多的进程来响应请求，一旦进程多了，CPU对进程的切换就频繁了，很耗资源和时间，所以导致apache性能下降，处理不过来这么多进程了。其实如果对于进程每个请求都没阻塞，那效率肯定会提高很多。</p>
<p>​        Nginx采用 epoll 模型，异步非阻塞。对于Nginx，把一个完整的连接请求处理都划分成了事件，一个个的事件。如accept（）， recv（），磁盘I/O，send（）等，每部分都有相应的模块去处理，一个完整的请求可能是由几百个模块去处理。真正核心的就是事件收集和分发模块，这就是管理所有模块的核心。只有核心模块的调度才能让对应的模块占用CPU资源，从而处理请求。拿一个HTTP请求来说，首先在事件收集分发模块注册感兴趣的监听事件，注册好后不阻塞直接返回，接下来就不需再管了，等待有连接来了内核会通知你(epoll的轮询会告诉进程)，cpu就可处理其他事情去。一旦有请求来，那对整个请求分配相应的上下文（其实已预先分配好），这时再注册新的感兴趣的事件(read函数)，同样客户端数据来了内核会自动通知进程可以去读数据了，读数据后就是解析，解析完后去磁盘找资源（I/O），一旦I/O完成会通知进程，进程开始给客户端发回数据send()，这时也不是阻塞的，调用后就等内核发回通知发送的结果就行。整个下来把一个请求分成了很多个阶段，每个阶段都到很多模块去注册，然后处理，都是异步非阻塞。异步指的就是做一个事情，不需等返回结果，做好后会自动通知你。</p>
<p><strong>select/epoll的特点</strong></p>
<p><strong>select 特点：</strong></p>
<p>​        select 选择句柄时，是遍历所有句柄，即句柄有事件响应时，select需遍历所有句柄才能获取到哪些句柄有事件通知，因此效率非常低。但是如果连接很少时，select 和 epoll 的LT触发模式相比， 性能上差别不大。<br>这里多说一句，select支持的句柄数是有限制的， 同时只支持1024个，这个是句柄集合限制的，如超过这个限制，很可能导致溢出，且非常不容易发现问题， 当然可通过修改linux的socket内核调整这个参数。<br><strong>epoll特点：</strong></p>
<p>​        epoll对于句柄事件的选择不是遍历的，是事件响应的，就是句柄上事件来就马上选择出来，不需遍历整个句柄链表，因此效率非常高，内核将句柄用红黑树保存的。<br>​        对于epoll而言还有ET和LT的区别，LT表水平触发，ET表边缘触发，两者在性能以及代码实现上差别也是非常大的。</p>
<p>​        不管是Nginx还是Squid这种反向代理，其网络模式都是事件驱动。事件驱动其实是很老的技术，早期的select、poll都是如此。后来基于内核通知的更高级事件机制出现，如libevent里的epoll，使事件驱动性能得以提高。事件驱动的本质还是IO事件，应用程序在多个IO句柄间快速切换，实现所谓的异步IO。事件驱动服务器，最适合做的就是这种IO密集型工作，如反向代理，它在客户端与WEB服务器之间起一个数据中转作用，纯粹是IO操作，自身并不涉及到复杂计算。反向代理用事件驱动来做，显然更好，一个工作进程就可run了，没有进程、线程管理的开销，CPU、内存消耗都小。</p>
<p>​        所以Nginx、Squid都是这样做的。当然，Nginx也可是多进程 + 事件驱动的模式，几个进程跑libevent，不需要Apache那样动辄数百的进程数。Nginx处理静态文件效果也很好，那是因为静态文件本身也是磁盘IO操作，处理过程一样。至于说多少万的并发连接，这个毫无意义。随手写个网络程序都能处理几万的并发，但如果大部分客户端阻塞在那里，就没什么价值。</p>
<p>​        再看看Apache或者Resin这类应用服务器，之所以称他们为应用服务器，是因为他们真的要跑具体的业务应用，如科学计算、图形图像、数据库读写等。它们很可能是CPU密集型的服务，事件驱动并不合适。例如一个计算耗时2秒，那么这2秒就是完全阻塞的，什么event都没用。想想MySQL如果改成事件驱动会怎么样，一个大型的join或sort就会阻塞住所有客户端。这个时候多进程或线程就体现出优势，每个进程各干各的事，互不阻塞和干扰。当然，现代CPU越来越快，单个计算阻塞的时间可能很小，但只要有阻塞，事件编程就毫无优势。所以进程、线程这类技术，并不会消失，而是与事件机制相辅相成，长期存在。</p>
<p>​        总言之，事件驱动适合于IO密集型服务，多进程或线程适合于CPU密集型服务，它们各有各的优势，并不存在谁取代谁的倾向。</p>

  </article>

  
      
    <div class="nexmoe-post-copyright">
        <strong>Author：</strong>Shuyan<br>
        <strong>Link：</strong><a href="http://example.com/2022/03/17/JAVA/Nginx/Nginx%E5%85%A5%E9%97%A8/" title="http:&#x2F;&#x2F;example.com&#x2F;2022&#x2F;03&#x2F;17&#x2F;JAVA&#x2F;Nginx&#x2F;Nginx%E5%85%A5%E9%97%A8&#x2F;" target="_blank" rel="noopener">http:&#x2F;&#x2F;example.com&#x2F;2022&#x2F;03&#x2F;17&#x2F;JAVA&#x2F;Nginx&#x2F;Nginx%E5%85%A5%E9%97%A8&#x2F;</a><br>
        
            <strong>版权声明：</strong>本文采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/cn/deed.zh" target="_blank">CC BY-NC-SA 3.0 CN</a> 协议进行许可
        
    </div>


  
  
  <div class="nexmoe-post-meta nexmoe-rainbow">
    
        <a class="nexmoefont icon-appstore-fill -link" href="/categories/JAVA/">JAVA</a><a class="nexmoefont icon-appstore-fill -link" href="/categories/JAVA/%E2%80%9CNginx%E2%80%9D/">“Nginx”</a>
    
    
        <a class="nexmoefont icon-tag-fill -none-link" href="/tags/Nginx/" rel="tag">Nginx</a>
    
</div>

  
      <div class="nexmoe-post-footer">
          <section class="nexmoe-comment">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.css">
<div id="gitalk"></div>
<script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script>
<script type="text/javascript">
    var gitalk = new Gitalk({
        clientID: '80b2453b6d5f37ad6225',
        clientSecret: '43e99fa852795c9a7b3eb924b2558c64b84bbdeb',
        id: window.location.pathname,
        repo: 'nexmoe.github.io',
        owner: 'nexmoe',
        admin: 'nexmoe'
    })
    gitalk.render('gitalk')
</script>
</section>
      </div>
  
</div>
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                              <button class="mdui-fab catalog" style="overflow:unset;">
                                  <i class="nexmoefont icon-i-catalog"></i>
                                  <div class="nexmoe-toc">
                                      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">一、安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-windows"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-1-%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1.1 下载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-2-%E5%90%AF%E5%8A%A8"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.1.2 启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-3-%E9%AA%8C%E8%AF%81"><span class="toc-number">1.1.3.</span> <span class="toc-text">1.1.3 验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-4-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.1.4.</span> <span class="toc-text">1.1.4 基本操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-Linux"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 Linux</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-1-Nginx%E4%BE%9D%E8%B5%96%E5%8C%85"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.2.1 Nginx依赖包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-2-%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2.2 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#step-1%EF%BC%9A%E4%B8%8B%E8%BD%BD%E6%89%80%E9%9C%80%E5%8C%85"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">step 1：下载所需包</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step-2%EF%BC%9A%E5%AE%89%E8%A3%85OpenSSL"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">step 2：安装OpenSSL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step-3%EF%BC%9A%E5%AE%89%E8%A3%85zlib"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">step 3：安装zlib</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step-4%EF%BC%9A%E5%AE%89%E8%A3%85pcre"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">step 4：安装pcre</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#step-5%EF%BC%9A%E5%AE%89%E8%A3%85Nginx"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">step 5：安装Nginx</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-3-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.2.3 基本操作指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-Nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E"><span class="toc-number">1.3.</span> <span class="toc-text">1.3 Nginx配置文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-1-main%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.1.</span> <span class="toc-text">1.3.1 main模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-2-event%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.2.</span> <span class="toc-text">1.3.2 event模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-3-http%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.3.</span> <span class="toc-text">1.3.3 http模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">1）基础配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">2）日志配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89SSL%E8%AF%81%E4%B9%A6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">3）SSL证书配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%EF%BC%89%E5%8E%8B%E7%BC%A9%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.4.</span> <span class="toc-text">4）压缩配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5%EF%BC%89%E6%96%87%E4%BB%B6%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.5.</span> <span class="toc-text">5）文件缓存配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-4-sever%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.4.</span> <span class="toc-text">1.3.4 sever模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-5-location%E6%A8%A1%E5%9D%97"><span class="toc-number">1.3.5.</span> <span class="toc-text">1.3.5 location模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">1）基本配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%EF%BC%89%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.2.</span> <span class="toc-text">2）反向代理配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%EF%BC%89uwsgi%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.5.3.</span> <span class="toc-text">3）uwsgi配置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-6-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A8%A1%E5%9D%97%EF%BC%88upstream%EF%BC%89"><span class="toc-number">1.3.6.</span> <span class="toc-text">1.3.6 负载均衡模块（upstream）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-4-Nginx%E4%B8%BB%E8%A6%81%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.</span> <span class="toc-text">1.4 Nginx主要配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-1-%E9%9D%99%E6%80%81Http%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.1.</span> <span class="toc-text">1.4.1 静态Http服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-2-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.2.</span> <span class="toc-text">1.4.2 反向代理服务器配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-3-%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">1.4.3.</span> <span class="toc-text">1.4.3 虚拟主机配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-4-Nginx%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8-%E6%96%B9%E6%B3%951%EF%BC%8C%E9%80%82%E7%94%A8CentOS7%EF%BC%8Csystemctl%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.4.4.</span> <span class="toc-text">1.4.4 Nginx开机启动(方法1，适用CentOS7，systemctl管理服务)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CentOS7%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E8%84%9A%E6%9C%AC%E7%9B%AE%E5%BD%95"><span class="toc-number">1.4.4.0.1.</span> <span class="toc-text">CentOS7系统服务脚本目录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%BC%96%E5%86%99service%E8%84%9A%E6%9C%AC"><span class="toc-number">1.4.4.0.2.</span> <span class="toc-text">编写service脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%EF%BC%88%E5%BC%BA%E5%A4%A7%E7%9A%84CentOS%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7systemctl%EF%BC%89"><span class="toc-number">1.4.5.</span> <span class="toc-text">设置开机启动（强大的CentOS服务管理工具systemctl）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-5-Nginx%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8-%E6%96%B9%E6%B3%952%EF%BC%8C%E9%80%82%E7%94%A8CentOS7%E4%BB%A5%E4%B8%8B"><span class="toc-number">1.4.6.</span> <span class="toc-text">1.4.5 Nginx开机启动(方法2，适用CentOS7以下)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Nginx%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">二、Nginx入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-Nginx%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 Nginx功能介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Nginx%E5%8F%AF%E4%BB%A5%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Nginx可以提供的服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Nginx%E4%BC%98%E5%8A%BF"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Nginx优势</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-Nginx%E5%BA%94%E7%94%A8%E5%9C%BA%E5%90%88"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 Nginx应用场合</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-Nginx%E7%9B%91%E6%8E%A7"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 Nginx监控</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-1-%E5%BC%80%E5%90%AF%E7%8A%B6%E6%80%81%E9%A1%B5"><span class="toc-number">2.5.1.</span> <span class="toc-text">2.5.1 开启状态页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-2-%E9%85%8D%E7%BD%AE%E7%99%BB%E5%BD%95%E5%AF%86%E7%A0%81"><span class="toc-number">2.5.2.</span> <span class="toc-text">2.5.2 配置登录密码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-3-%E8%AE%BF%E9%97%AEURL"><span class="toc-number">2.5.3.</span> <span class="toc-text">2.5.3 访问URL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-4-%E7%BC%96%E5%86%99zabbix%E7%9B%91%E6%8E%A7%E8%84%9A%E6%9C%AC"><span class="toc-number">2.5.4.</span> <span class="toc-text">2.5.4 编写zabbix监控脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-6-Nginx%E4%BC%98%E5%8C%96"><span class="toc-number">2.6.</span> <span class="toc-text">2.6 Nginx优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-1-nginx%E5%86%85%E6%A0%B8%E4%BC%98%E5%8C%96"><span class="toc-number">2.6.1.</span> <span class="toc-text">2.6.1 nginx内核优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-2-TCP-%E4%BC%98%E5%8C%96"><span class="toc-number">2.6.2.</span> <span class="toc-text">2.6.2 TCP 优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-3-%E5%BC%80%E5%90%AF-Gzip"><span class="toc-number">2.6.3.</span> <span class="toc-text">2.6.3 开启 Gzip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-4-%E5%BC%80%E5%90%AF%E7%BC%93%E5%AD%98"><span class="toc-number">2.6.4.</span> <span class="toc-text">2.6.4 开启缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">2.6.4.1.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.6.4.2.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-5-%E4%BD%BF%E7%94%A8-SPDY%EF%BC%88HTTP-2%EF%BC%89"><span class="toc-number">2.6.5.</span> <span class="toc-text">2.6.5 使用 SPDY（HTTP&#x2F;2）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-6-HTTPS-%E4%BC%98%E5%8C%96"><span class="toc-number">2.6.6.</span> <span class="toc-text">2.6.6 HTTPS 优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-7-%E6%89%A9%E5%B1%95%E4%B8%80%EF%BC%9Anginx%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">2.7.</span> <span class="toc-text">2.7 扩展一：nginx全局变量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-plus-%E2%80%93-ngx-http-status-module"><span class="toc-number">2.7.1.</span> <span class="toc-text">nginx plus – ngx_http_status_module</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-access-log-%E5%88%86%E6%9E%90"><span class="toc-number">2.7.2.</span> <span class="toc-text">nginx access log 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NDK-%E2%80%93-ngx-devel-kit"><span class="toc-number">2.7.3.</span> <span class="toc-text">NDK – ngx_devel_kit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-lua-%E2%80%93-lua-nginx-module"><span class="toc-number">2.7.4.</span> <span class="toc-text">nginx lua – lua-nginx-module</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-8-%E6%89%A9%E5%B1%95%E4%BA%8C%EF%BC%9Aweb%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86%E6%A8%A1%E5%9E%8B"><span class="toc-number">2.8.</span> <span class="toc-text">2.8 扩展二：web服务器事件处理模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-1-select"><span class="toc-number">2.8.1.</span> <span class="toc-text">2.8.1 select</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-2-poll"><span class="toc-number">2.8.2.</span> <span class="toc-text">2.8.2 poll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-3-epoll"><span class="toc-number">2.8.3.</span> <span class="toc-text">2.8.3 epoll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-4-nginx-s-reload-%E8%BF%87%E7%A8%8B"><span class="toc-number">2.8.4.</span> <span class="toc-text">2.8.4 nginx -s reload 过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-8-5-Apache-select%E6%A8%A1%E5%9E%8B%E5%92%8C-nginx-epoll-%E6%A8%A1%E5%9E%8B%E5%AF%B9%E6%AF%94%E8%AE%B2%E8%A7%A3"><span class="toc-number">2.8.5.</span> <span class="toc-text">2.8.5 Apache select模型和 nginx epoll 模型对比讲解</span></a></li></ol></li></ol></li></ol>
                                  </div>
                              </button>
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
     
    <div id="nexmoe-search-space">
        <div class="search-container">
            <div class="search-header">
                <div class="search-input-container">
                    <input class="search-input" type="text" placeholder="Search" oninput="sinput();">
                </div>
                <a class="search-close" onclick="sclose();">×</a>
            </div>
            <div class="search-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1650551263753"></script>



<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





    <!-- baidu Analytics -->
<script>
    var _hmt = _hmt || [];
    (function() {var hm = document.createElement('script');
    hm.src = 'https://hm.baidu.com/hm.js?0a7e154da92f76d05c83b48cbab331da#&lt;ID&gt;';
    var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

</body>

</html>
